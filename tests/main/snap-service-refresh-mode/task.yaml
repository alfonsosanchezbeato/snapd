summary: "Check that refresh-modes works"

kill-timeout: 5m

debug: |
    grep -n '' *.pid || true
    systemctl status snap.test-snapd-service.test-snapd-endure-service || true

execute: |
    # shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB/snaps.sh"
    # shellcheck source=tests/lib/journalctl.sh
    . "$TESTSLIB/journalctl.sh"

    echo "When the service snap is installed"
    systemctl status snap.test-snapd-service.test-snapd-sighup-all-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigusr1-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigusr2-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sighup-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-service-refuses-to-stop.service || true
    systemctl status snap.test-snapd-service.test-snapd-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigusr1-all-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigterm-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigusr2-all-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-sigterm-all-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-endure-service.service || true
    systemctl status snap.test-snapd-service.test-snapd-other-service.service || true
    ls -l /etc/systemd/system || true
    install_local test-snapd-service

    echo "We can see it running"
    systemctl status snap.test-snapd-service.test-snapd-endure-service|MATCH "running"
    systemctl show -p MainPID snap.test-snapd-service.test-snapd-endure-service > old-main.pid

    echo "When it is re-installed"
    install_local test-snapd-service

    echo "We can still see it running with the same PID"
    systemctl show -p MainPID snap.test-snapd-service.test-snapd-endure-service > new-main.pid

    test "$(cat new-endure.pid)" = "$(cat old-endure.pid)"

    echo "Once the snap is removed, the service is stopped"
    snap remove test-snapd-service
    get_journalctl_log | MATCH "stop endure"

restore:
    rm -f *.pid || true
