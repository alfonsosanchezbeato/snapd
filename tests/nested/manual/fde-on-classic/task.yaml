summary: Check that a FDE based classic image can be booted

details: |
  This test creates a classic image that looks like what the installer
  would create and we boot into it.

systems: [ubuntu-22.04-64]

environment:
  NESTED_ENABLE_SECURE_BOOT: false
  NESTED_USE_CLOUD_INIT: true

prepare: |
  # create an image that looks like a classic image
  # Note that "mk-image" is left as a script so that it can also be
  # run outside of spread easily for quick interactive testing
  cache_p=$(mktemp -d -u)
  ./mk-image.sh ./boot.img "$cache_p"
  # replaces snap-bootstrap in initramfs and snapd in rootfs
  # TODO chroot install of deb? /home/gopath/src/github.com/snapcore/snapd_*_amd64.deb
  ./replace-image-files.sh ./boot.img "$cache_p"
  rm -rf "$cache_p"

execute: |
  #shellcheck source=tests/lib/nested.sh
  . "$TESTSLIB/nested.sh"
  # run built image
  nested_start_core_vm_unit "$PWD"/boot.img

  # and validate it boots and seeds
  tests.nested exec "sudo snap wait system seed.loaded"

  tests.nested exec 'cat /etc/os-release | MATCH VERSION_ID=\"22.04\"'
